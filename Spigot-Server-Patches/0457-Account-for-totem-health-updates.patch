From 94e74e7f7edf0c297c610069b32a874dc509b577 Mon Sep 17 00:00:00 2001
From: Tom <cryptite@gmail.com>
Date: Sun, 26 Apr 2020 10:34:09 -0500
Subject: [PATCH] Account for totem health updates


diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 6ccf00840..4cac5d132 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -128,6 +128,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     private double health = 20;
     private boolean scaledHealth = false;
     private double healthScale = 20;
+    private double lastUpdatedHealth;
     // Paper start
     private org.bukkit.event.player.PlayerResourcePackStatusEvent.Status resourcePackStatus;
     private String resourcePackHash;
@@ -1717,7 +1718,8 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
 
         float scaledHealth = getScaledHealth();
         double maxHealth = getMaxHealth();
-        if (CraftServer.cullPackets && (scaledHealth <= 0 || scaledHealth >= maxHealth)) {
+        if (CraftServer.cullPackets && (scaledHealth <= 0 || scaledHealth >= maxHealth || lastUpdatedHealth <= 0)) {
+            lastUpdatedHealth = scaledHealth;
             getHandle().getDataWatcher().set(EntityLiving.HEALTH, scaledHealth);
         }
 
-- 
2.17.1.windows.2

